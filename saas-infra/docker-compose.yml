version: "3.8"

services:
  # --- TRAEFIK (GATEWAY) ---
  reverse-proxy:
    image: traefik:v3.0
    container_name: traefik
    command:
      - "--api.insecure=true"                   # Bật Dashboard 8080
      - "--providers.docker=true"               # Đọc Docker
      - "--providers.docker.exposedbydefault=false" # Chỉ định tuyến khi có label
      - "--entrypoints.web.address=:80"         # Cổng Web 80
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # OrbStack tự handle cái này
    networks:
      - saas-network

  # --- TEST SERVICE ---
  whoami:
    image: traefik/whoami
    container_name: whoami_test
    labels:
      - "traefik.enable=true"
      # Định tuyến: Host là test.localhost thì vào đây
      - "traefik.http.routers.whoami.rule=Host(`test.localhost`)"
    networks:
      - saas-network

  # --- CITUS COORDINATOR ---
  citus-coordinator:
    image: citusdata/citus:12.1
    container_name: citus_coordinator
    environment: &citus_env
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mysecretpassword
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5433:5432" # Expose để check bằng DBeaver
    volumes:
      - citus-coord-data:/var/lib/postgresql/data
    networks:
      - saas-network
    labels:
      - "traefik.enable=false"

  # --- CITUS WORKER 1 ---
  citus-worker-1:
    image: citusdata/citus:12.1
    container_name: citus_worker_1
    environment: *citus_env
    command: postgres -c "listen_addresses=*"
    networks:
      - saas-network
    depends_on:
      - citus-coordinator

  # --- CITUS WORKER 2 ---
  citus-worker-2:
    image: citusdata/citus:12.1
    container_name: citus_worker_2
    environment: *citus_env
    command: postgres -c "listen_addresses=*"
    networks:
      - saas-network
    depends_on:
      - citus-coordinator

  # --- CITUS MANAGER (AUTO SETUP) ---
  citus-manager:
    image: citusdata/citus:12.1
    container_name: citus_manager
    depends_on:
      - citus-coordinator
      - citus-worker-1
    networks:
      - saas-network
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        sleep 10;
        psql -h citus-coordinator -U postgres -c "SELECT * from master_add_node('citus-worker-1', 5432)";
        psql -h citus-coordinator -U postgres -c "SELECT * from master_add_node('citus-worker-2', 5432)";
        echo "Cluster setup complete!";

  # --- MATTERMOST (APP) ---
  # mattermost:
  #   image: mattermost/mattermost-team-edition:9.5
  #   container_name: mattermost_app
  #   restart: unless-stopped
  #   security_opt:
  #     - no-new-privileges:true
  #   pids_limit: 200
  #   depends_on:
  #     - citus-coordinator
  #   networks:
  #     - saas-network
  #   environment:
  #     # Kết nối vào Citus Coordinator
  #     - MM_SQLSETTINGS_DRIVERNAME=postgres
  #     - MM_SQLSETTINGS_DATASOURCE=postgres://postgres:mysecretpassword@citus-coordinator:5432/postgres?sslmode=disable&connect_timeout=10
  #     # Tên miền (Quan trọng để Mattermost biết nó là ai)
  #     - MM_SERVICESETTINGS_SITEURL=http://chat.localhost
  #   labels:
  #     - "traefik.enable=true"
  #     # Định tuyến: chat.localhost -> Vào cổng 8065 của container này
  #     - "traefik.http.routers.mattermost.rule=Host(`chat.localhost`)"
  #     - "traefik.http.routers.mattermost.service=mattermost"
  #     - "traefik.http.services.mattermost.loadbalancer.server.port=8065"

networks:
  saas-network:
    driver: bridge

volumes:
  citus-coord-data: